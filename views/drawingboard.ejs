<!DOCTYPE html>
<html>
<head>
<!-- Load the Paper.js library -->
<script type="text/javascript" src="../js/paper.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"type="text/javascript"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<script type="text/javascript" src="/socket.io/socket.io.js"></script>

<script type="text/javascript" src="../jscolor/jscolor.js"></script>
<!-- Define inlined PaperScript associate it with myCanvas -->
<style type="text/css">
  ul {
    list-style-type: circle;
    list-style-position: inside;
    padding-left:0px;
  }
  
  #messages {
    border: 1px solid silver;
    padding: 10px;
    width:100%;
    height:188px;
    overflow-y: scroll;
  }

  #users {
    border: 1px solid silver;
    padding: 10px;
    width:100%;
    height:188px;
    overflow-y: scroll;
  }

  .tools {
    margin-top:10px;
  }

  #myCanvas {
    width:100%; 
    height:100%;
    border-style: 1px solid;
    border-width: 27px;
    -moz-border-image: url(http://www.w3.org/TR/css3-background/border.png) 27 repeat;
    -webkit-border-image: url(http://www.w3.org/TR/css3-background/border.png) 27 repeat;
    -o-border-image: url(http://www.w3.org/TR/css3-background/border.png) 27 repeat;
    border-image: url(http://www.w3.org/TR/css3-background/border.png) 27 fill repeat;
    cursor: url(/img/pen.png), auto;
  }

  .inline {
    display:inline-block;
  }
</style>
<script type="text/javascript">
 
  
   $(window).load(function(){
        $('#myModal').modal({backdrop: 'static', keyboard: false});
    });
</script>
</head>

<body>


<div class="container">
  <div id='canvas' class='col-md-9'>
    <h1>Drawing Board</h1>
    <canvas id="myCanvas"></canvas>
  </div>
  <div class='col-md-3' id='chatroom'>
    <h1>Chat</h1>
    <div id='messages'></div>
    <form id='send'>
      <input id='message' class='form-control' autocomplete="off">
    </form>
  </div>
  <div class='col-md-3'>
    <h4>Users</h4>
    <div id='users'></div>
  </div>
  <div class="tools col-md-12">
    <img class='inline' id='brush' src='/img/pen.png'>
    Color:<input id='color' class="color inline">
    <img class='inline' id='eraser' src='/img/cursor-eraser.png'>
    <input type="button" id="clear" value="Clear">
    <p>Brush Size:<input class='inline' id='range' type="range" min="5" max="50" step="5" value='5' style="width:50px"></p>
  </div>
  
  
<div class="modal fade" id='myModal'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Time to Start Drawing!</h4>
      </div>
      <div class="modal-body">
      
        <label for="name" class="control-label">Please Enter Name:</label>
        <input id="name" class="form-control" type='text' autocomplete="off"></input>
      
      </div>
      <div class="modal-footer">
        <button type="button" id='close_modal' class="btn btn-default" data-dismiss="modal">Enter</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

</div>
<script type="text/javascript">
   

</script>
<script type="text/paperscript" canvas="myCanvas">

  var socket = io.connect();
  var color = $('#color').val('000000');
  var canvas = document.getElementById('myCanvas');
  var path;
  var currentMode = "drawing"

  $('#close_modal').click(function(){
    var name = $('#name').val();
    socket.emit('user_joined', {name: name, room: window.location.pathname});
  })
  // chatting

  $('#send').submit(function(){
    socket.emit("send_message", {message:$('#message').val()});
    $('#message').val('');
    return false;
  })

  socket.on("sent_message", function (data){
    $('#messages').append($('<p>').text(data.message));
    var elem = document.getElementById('messages'); // = $('#history')
    elem.scrollTop = elem.scrollHeight;
    $('.chatbox').scrollTop = $('.chatbox').scrollHeight; 
  });

  socket.on('update_user_list', function (data){
    var users_list = "<ul>"
    for (var i = 0; i < data.length; i++){
      users_list += '<li>' + data[i] + '</li>';
    }
    users_list += '</ul>';
    $("#users").html(users_list);

    var elem = document.getElementById('users'); // = $('#history')
    elem.scrollTop = elem.scrollHeight;
    $('.chatbox').scrollTop = $('.chatbox').scrollHeight; 
  })




  // drawing

  function onMouseDown(event) {
    var color = $('#color');
    var range = $('#range');
    var signal = {}

    signal.currentMode = currentMode;
    signal.point = event.point;
    signal.color = color.val();
    signal.range = range.val();
    socket.emit('onMouseDown', signal);

    if (signal.currentMode == 'drawing'){
      path = new Path();
      path.strokeCap = 'round';
      path.strokeJoin = 'round';
      path.strokeColor = '#'+signal.color;
      path.strokeWidth = signal.range;
      path.add(signal.point);
    } else {

      path = new Path();
      path.strokeCap = 'round';
      path.strokeJoin = 'round';
      path.strokeColor = '#FFFFFF';
      path.strokeWidth = signal.range;
      path.add(signal.point);
    }

  }

  function onMouseDrag(event) {
    var point = {x:event[1], y:event[2]};
    path.add(event.point);
    socket.emit('onMouseDrag', event.point);
  }
  function serialize(canvas) {
    return canvas.toDataURL();
  }



  socket.on('OtherOnMouseDown', function (event){
    if (event.currentMode == 'drawing'){
      
      var point = {x:event.point[1], y:event.point[2]}
      path = new Path();
      path.strokeCap = 'round';
      path.strokeJoin = 'round';
      path.strokeColor = '#'+event.color;
      path.strokeWidth = event.range;
      path.add(point);
    } else {

      var point = {x:event.point[1], y:event.point[2]}
      path = new Path();
      path.strokeCap = 'round';
      path.strokeJoin = 'round';
      path.strokeColor = '#FFFFFF';
      path.strokeWidth = event.range;
      path.add(point);
    }

  })
  socket.on('OtherOnMouseDrag', function (event){
    var point = {x:event[1], y:event[2]};
    path.add(point);
    paper.view.update();
  })

  socket.on('clear', function(){
    project.clear()
    paper.view.update();
  })

  $('#clear').click(function(){
    project.clear();
    paper.view.update();
    socket.emit('clear');
  })

  socket.emit('need_drawing',{room: window.location.pathname});

  socket.on('get_drawing', function() {
    var img_code = serialize(canvas);
    socket.emit('return_drawing', {img: img_code });
  })

  socket.on('insert_drawing', function(data) {
    var raster = new Raster(data.img, view.center );
  })

  $('#brush').click(function(){
    currentMode = 'drawing';
    $('#myCanvas').css('cursor', 'url(/img/pen.png), auto');
  })

  $('#eraser').click(function(){
    currentMode ='eraser'
    $('#myCanvas').css('cursor', 'url(/img/cursor-eraser.png), auto');
  })




  


</script>
</body>
</html>